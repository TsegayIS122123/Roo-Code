# Phase 1: The Handshake - Complete Implementation

## ğŸ“‹ Overview

This document describes the complete implementation of the Intent Handshake protocol, solving the Context Paradox by bridging synchronous LLM reasoning with asynchronous IDE operations.

## ğŸ¯ Goal Achieved

The agent **MUST** select an intent before any code changes. The system injects full context (constraints, scope, and recent history) into the LLM's context window.

---

## ğŸ”§ Implementation Components

| Component             | File                                       | Responsibility                         |
| --------------------- | ------------------------------------------ | -------------------------------------- |
| **Tool Definition**   | `src/core/tools/SelectActiveIntentTool.ts` | Defines the intent selection tool      |
| **Intent Loader**     | `src/hooks/utils/intentLoader.ts`          | Parses YAML and loads trace history    |
| **Context Generator** | `getEnhancedIntentContext()`               | Creates XML with intent + history      |
| **Trace Loader**      | `getRecentTracesForIntent()`               | Fetches related trace entries          |
| **Gatekeeper**        | `src/hooks/preHooks.ts:intentGatekeeper`   | Validates intent before tool execution |
| **System Prompt**     | `src/core/prompts/intentRequirement.ts`    | Enforces intent-first protocol         |

---

## ğŸ”„ Complete Handshake Flow

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMPLETE HANDSHAKE FLOW â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 1: User Request â”‚ â”‚
â”‚ â”‚ "Build Weather API endpoint" â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 2: System Prompt (with MANDATORY rule) â”‚ â”‚
â”‚ â”‚ "You MUST call select_active_intent first" â”‚ â”‚
â”‚ â”‚ File: src/core/prompts/intentRequirement.ts â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 3: Agent calls select_active_intent("INT-001") â”‚ â”‚
â”‚ â”‚ File: src/core/tools/SelectActiveIntentTool.ts â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 4: Context Loader â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€ Reads .orchestration/active_intents.yaml â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€ Finds INT-001 configuration â”‚ â”‚
â”‚ â”‚ â””â”€â”€ Loads recent trace entries from agent_trace.jsonl â”‚ â”‚
â”‚ â”‚ File: src/hooks/utils/intentLoader.ts â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 5: XML Context Generation â”‚ â”‚
â”‚ â”‚ Function: getEnhancedIntentContext() â”‚ â”‚
â”‚ â”‚ Output: Complete XML with constraints + traces â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 6: Tool Returns Context â”‚ â”‚
â”‚ â”‚ {
â”‚ â”‚ "status": "success",
â”‚ â”‚ "context": "<xml_context>",
â”‚ â”‚ "trace_count": 3,
â”‚ â”‚ "timestamp": "2026-02-19T..."
â”‚ â”‚ }
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 7: Context Injected into Next LLM Prompt â”‚ â”‚
â”‚ â”‚ Agent now has full context about the intent â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 8: Tool Call (write_to_file) with intent in sessionâ”‚ â”‚
â”‚ â”‚ Session now has intentId = "INT-001" â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 9: Pre-Hook Gatekeeper â”‚ â”‚
â”‚ â”‚ File: src/hooks/preHooks.ts:intentGatekeeper â”‚ â”‚
â”‚ â”‚ â””â”€â”€ Validates: session.intentId = "INT-001" âœ“ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 10: Tool Executes â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â”‚
â”‚ â–¼ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ STEP 11: Post-Hook Records Trace â”‚ â”‚
â”‚ â”‚ File: src/hooks/postHooks.ts:traceRecorder â”‚ â”‚
â”‚ â”‚ â””â”€â”€ Links code â†’ INT-001 in agent_trace.jsonl â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

text

---

## ğŸ“¦ Data Formats

### 1. Intent Selection Request

```json
{
	"tool": "select_active_intent",
	"params": {
		"intent_id": "INT-001"
	}
}
```

2.  Generated XML Context (Full Version)
    xml
    <intent_context>
    <id>INT-001</id>
    <name>Weather API</name>
    <status>ACTIVE</status>
        <constraints>
            <constraint>Use OpenWeather API</constraint>
            <constraint>Rate limit: 60 requests/minute</constraint>
        </constraints>

        <owned_scope>
            <scope>src/api/weather/**</scope>
            <scope>src/models/weather.ts</scope>
        </owned_scope>

        <acceptance_criteria>
            <criteria>Unit tests in tests/api/weather/ pass</criteria>
            <criteria>API documentation generated</criteria>
        </acceptance_criteria>

        <recent_activity>
            <!-- Activity 1 (2/19/2026, 10:00:00 AM) -->
            <modified_file path="src/api/weather/fetch.ts" />

            <!-- Activity 2 (2/19/2026, 9:30:00 AM) -->
            <modified_file path="src/api/weather/types.ts" />
        </recent_activity>
    </intent_context>
3.  Tool Response (Full Version)
    json
    {
    "status": "success",
    "message": "âœ… Intent INT-001 selected successfully",
    "context": "<xml_context>",
    "trace_count": 2,
    "timestamp": "2026-02-19T10:30:00Z",
    "intent_id": "INT-001",
    "summary": {
    "id": "INT-001",
    "trace_count": 2,
    "has_constraints": true,
    "has_scope": true,
    "has_traces": true
    }
    }
4.  Error Response
    json
    {
    "status": "error",
    "message": "Intent INT-999 not found in active_intents.yaml",
    "suggestion": "Check .orchestration/active_intents.yaml for valid intent IDs"
    }
    ğŸ§ª Test Coverage
    Test File Tests Description
    src/**tests**/phase1-handshake.test.ts 4 tests Unit tests for trace loading and XML generation
    src/**tests**/phase1-integration.test.ts 3 tests End-to-end flow verification
    Run tests:

bash
pnpm test src/**tests**/phase1-handshake.test.ts
pnpm test src/**tests**/phase1-integration.test.ts
ğŸ“ File Structure Summary
src/
â”œâ”€â”€ core/
â”‚ â”œâ”€â”€ prompts/
â”‚ â”‚ â”œâ”€â”€ system.ts # Modified with intent requirement
â”‚ â”‚ â””â”€â”€ intentRequirement.ts # MANDATORY rules text
â”‚ â””â”€â”€ tools/
â”‚ â”œâ”€â”€ SelectActiveIntentTool.ts # Intent selection tool (UPDATED)
â”‚ â””â”€â”€ toolRegistration.ts # Tool registry
â”œâ”€â”€ hooks/
â”‚ â”œâ”€â”€ index.ts # Hook registry
â”‚ â”œâ”€â”€ preHooks.ts # intentGatekeeper, commandClassifier
â”‚ â”œâ”€â”€ postHooks.ts # traceRecorder, lessonRecorder
â”‚ â”œâ”€â”€ integration.ts # Hook initialization
â”‚ â””â”€â”€ utils/
â”‚ â””â”€â”€ intentLoader.ts # YAML parser + trace loader (UPDATED)
â””â”€â”€ **tests**/
â”œâ”€â”€ phase1-handshake.test.ts # Unit tests (NEW)
â””â”€â”€ phase1-integration.test.ts # Integration tests (NEW)
